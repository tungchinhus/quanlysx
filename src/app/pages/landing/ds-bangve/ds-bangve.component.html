<div class="container" style="max-width: 1200px; ">
  <div class="search-bar mat-elevation-z1" style="display: flex; align-items: center; gap: 16px; padding: 20px 24px 12px 24px; background: #fff; border-radius: 0 0 8px 8px;">
    <mat-form-field appearance="outline" class="search-autocomplete" style="flex: 1;">
      <mat-label>Tìm kiếm ký hiệu bảng vẽ</mat-label>
      <input type="text" matInput [matAutocomplete]="auto" [(ngModel)]="searchTerm" (ngModelChange)="filterAutoComplete()" placeholder="Nhập ký hiệu...">
      <mat-icon matPrefix>search</mat-icon>
      <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onAutoCompleteSelected($event)" [displayWith]="displayFn">
        <mat-option *ngFor="let drawing of filteredDrawingsForAutocomplete" [value]="drawing" class="custom-option">
          <div class="option-content">
            <div class="option-header">
              <span class="symbol">{{ drawing.kyhieubangve }}</span>
              <span class="power">{{ drawing.congsuat }}kVA - {{ drawing.dienap }}</span>
            </div>
            <div class="option-footer">
              <span class="info">TBKT: {{ drawing.tbkt }} | Người tạo: {{ drawing.user_create }}</span>
            </div>
          </div>
        </mat-option>
      </mat-autocomplete>
    </mat-form-field>
    <button mat-stroked-button class="add-btn" (click)="openAddBangVeDialog()" style="min-width: 110px;">
      <mat-icon>add</mat-icon> Thêm mới
    </button>
  </div>

  <div class="table-wrapper mat-elevation-z2" style="background: #fff; border-radius: 8px; margin-top: 24px; overflow-x: auto;">
    <mat-table [dataSource]="pagedDrawings" class="table" *ngIf="pagedDrawings.length > 0" matSort>
      <ng-container matColumnDef="kyhieubangve">
        <mat-header-cell *matHeaderCellDef> Ký hiệu </mat-header-cell>
        <mat-cell *matCellDef="let d"> <b>{{d.kyhieubangve}}</b> </mat-cell>
      </ng-container>
      <ng-container matColumnDef="congsuat">
        <mat-header-cell *matHeaderCellDef> Công suất </mat-header-cell>
        <mat-cell *matCellDef="let d"> {{d.congsuat}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="tbkt">
        <mat-header-cell *matHeaderCellDef> TBKT </mat-header-cell>
        <mat-cell *matCellDef="let d"> {{d.tbkt}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="dienap">
        <mat-header-cell *matHeaderCellDef> Điện áp </mat-header-cell>
        <mat-cell *matCellDef="let d"> {{d.dienap}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="bd_ha_trong">
        <mat-header-cell *matHeaderCellDef> BD Hạ Trong </mat-header-cell>
        <mat-cell *matCellDef="let d"> {{d.bd_ha_trong}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="bd_ha_ngoai">
        <mat-header-cell *matHeaderCellDef> BD Hạ Ngoài </mat-header-cell>
        <mat-cell *matCellDef="let d"> {{d.bd_ha_ngoai}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="bd_cao">
        <mat-header-cell *matHeaderCellDef> BD Cao </mat-header-cell>
        <mat-cell *matCellDef="let d"> {{d.bd_cao}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="bd_ep">
        <mat-header-cell *matHeaderCellDef> BD Ép </mat-header-cell>
        <mat-cell *matCellDef="let d"> {{d.bd_ep}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="bung_bd">
        <mat-header-cell *matHeaderCellDef> Bưng BD </mat-header-cell>
        <mat-cell *matCellDef="let d"> {{d.bung_bd}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="user_create">
        <mat-header-cell *matHeaderCellDef> Người tạo </mat-header-cell>
        <mat-cell *matCellDef="let d"> {{d.user_create}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="trang_thai">
        <mat-header-cell *matHeaderCellDef> Trạng thái </mat-header-cell>
        <mat-cell *matCellDef="let d">
          <mat-chip [color]="d.trang_thai ? 'primary' : 'warn'" selected>
            <mat-icon>{{d.trang_thai ? 'check_circle' : 'cancel'}}</mat-icon>
            {{d.trang_thai ? 'Đang hoạt động' : 'Ngừng'}}
          </mat-chip>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="created_at">
        <mat-header-cell *matHeaderCellDef> Ngày tạo </mat-header-cell>
        <mat-cell *matCellDef="let d"> {{d.created_at | date:'dd/MM/yyyy'}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="actions">
        <mat-header-cell *matHeaderCellDef class="column-actions"> Thao tác </mat-header-cell>
        <mat-cell *matCellDef="let d">
          <button mat-icon-button [matMenuTriggerFor]="actionMenu" aria-label="Menu hành động">
            <!-- <mat-icon>more_vert</mat-icon>  -->
             ...
          </button>

          <mat-menu #actionMenu="matMenu">
            <button mat-menu-item (click)="openBangVeDetailDialog(d,'view')">
              <span>Xem</span>
            </button>
            <button mat-menu-item (click)="openBangVeDetailDialog(d,'edit')">
              <span>Sửa</span>
            </button>
            <button mat-menu-item (click)="confirmGiaCong(d)">
               <span>Gia công</span>
            </button>
            </mat-menu>
        </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></mat-row>
    </mat-table>
    <mat-paginator [length]="filteredDrawings.length"
                   [pageSize]="pageSize"
                   [pageSizeOptions]="[5, 10, 20]"
                   (page)="onPageChange($event)"
                   style="border-radius: 0 0 8px 8px;">
    </mat-paginator>
    <div *ngIf="pagedDrawings.length === 0" class="empty-table" style="padding: 32px; text-align: center; color: #888;">
      <mat-icon style="font-size: 48px; color: #ccc;">inbox</mat-icon>
      <div style="margin-top: 8px;">Không có dữ liệu bảng vẽ.</div>
    </div>
  </div>
</div>
